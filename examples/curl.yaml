apiVersion: v1
kind: Pod
metadata:
  labels:
    run: curl-proxy
  annotations:
    sidecar.istio.io/inject: "true"
  name: curl-proxy
spec:
  serviceAccountName: user3
  # serviceAccountName: user-no-perm
  securityContext:
    fsGroup: 2000
  volumes:
    - name: jwks-volume
      configMap:
        name: jwks
    - name: policy-volume
      configMap:
        name: opa-policy-example
    - name: tokens-volume
      projected:
        sources:
        - serviceAccountToken:
            path: ptst1.svc.cluster.local
            expirationSeconds: 7200
            audience: ptst1.svc.cluster.local
        - serviceAccountToken:
            path: svc.cluster.local
            expirationSeconds: 7200
            audience: svc.cluster.local
        - serviceAccountToken:
            path: unscoped
            expirationSeconds: 7200
            audience: ""
    # - name: ns-token
    #   projected:
    #     sources:
    #     - serviceAccountToken:
    #         path: token
    #         expirationSeconds: 7200
    #         audience: ptst1.svc.cluster.local
    # - name: cluster-token
    #   projected:
    #     sources:
    #     - serviceAccountToken:
    #         path: token
    #         expirationSeconds: 7200
    #         audience: svc.cluster.local
    # - name: unscoped-token
    #   projected:
    #     sources:
    #     - serviceAccountToken:
    #         path: token
    #         expirationSeconds: 7200
    #         audience: ""
  initContainers:
  - name: kn-proxy-init
    image: github.com/yolocs/knative-policy/cmd/proxy-init
    env:
      - name: PROXY_INBOUND_PORT
        value: "8081"
      - name: PROXY_OUTBOUND_PORT
        value: "8082"
      - name: SERVICE_PORT
        value: "8080"
      - name: PROXY_OWNER
        value: "1337"
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
  containers:
    # This could be any image that we can SSH into and has curl.
  - image: governmentpaas/curl-ssl
    imagePullPolicy: IfNotPresent
    name: curl-proxy
    command: ["/bin/sleep", "3650d"]
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
    volumeMounts:
      - name: tokens-volume
        mountPath: /var/run/secrets/tokens
  - name: kn-proxy
    image: github.com/yolocs/knative-policy/cmd/proxy
    ports:
      - containerPort: 8081
        name: http-proxy-in
    securityContext:
      readOnlyRootFilesystem: true
      runAsUser: 1337
    volumeMounts:
      - name: tokens-volume
        mountPath: /var/run/secrets/tokens
    # volumeMounts:
      - name: jwks-volume
        mountPath: /var/run/configs/authn
      - name: policy-volume
        mountPath: /var/run/configs/authz
    # - name: ns-token
    #   mountPath: /var/run/secrets/tokens/ptst1.svc.cluster.local
    # - name: cluster-token
    #   mountPath: /var/run/secrets/tokens/svc.cluster.local
    # - name: unscoped-token
    #   mountPath: /var/run/secrets/tokens/UNSCOPED
    env:
      - name: NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
      - name: SERVICE_ACCOUNT
        valueFrom:
          fieldRef:
            fieldPath: spec.serviceAccountName
      - name: JWKS_FILE
        value: /var/run/configs/authn/jwks.json
      - name: POLICY_FILE
        value: /var/run/configs/authz/policy.rego
      - name: TOKEN_ROOT
        value: /var/run/secrets/tokens
      - name: ENABLE_REPLY_IDENTITY
        value: "true"
      - name: PROXY_INBOUND_PORT
        value: "8081"
      - name: PROXY_OUTBOUND_PORT
        value: "8082"
      - name: SERVICE_PORT
        value: "8080"
      - name: LOGGING_CONFIG
        value: |-
          {
            "level": "debug",
            "development": false,
            "outputPaths": ["stdout"],
            "errorOutputPaths": ["stderr"],
            "encoding": "json",
            "encoderConfig": {
              "timeKey": "ts",
              "levelKey": "level",
              "nameKey": "logger",
              "callerKey": "caller",
              "messageKey": "msg",
              "stacktraceKey": "stacktrace",
              "lineEnding": "",
              "levelEncoder": "",
              "timeEncoder": "iso8601",
              "durationEncoder": "",
              "callerEncoder": ""
            }
          }
      - name: LOGGING_LEVEL
